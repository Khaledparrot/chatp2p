<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Secure QR P2P Chat (Phone)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; padding:10px }
    input, button { width:100%; margin:5px 0; padding:10px; }
    #chat { background:#111; padding:10px; height:150px; overflow:auto; font-family:monospace }
    video { width:48%; margin:5px 0; background:#222 }
  </style>
</head>
<body>
  <h2>Secure QR P2P Chat (Phone Only)</h2>
  <input id="pwd" type="password" placeholder="Shared password (‚â•8 chars)">
  <button onclick="startOffer()">Generate Offer QR</button>
  <div id="qr"></div>
  <button onclick="startScan()">Scan Offer QR</button>
  <div id="reader" style="width:100%;height:300px"></div>

  <div id="chat">üïµÔ∏è Waiting‚Ä¶</div>
  <input id="msg" disabled placeholder="Type message">
  <button id="sendBtn" disabled onclick="sendMsg()">Send</button>

  <video id="me" autoplay muted playsinline></video>
  <video id="you" autoplay playsinline></video>
  <audio id="notif" src="https://notificationsounds.com/notification-sounds/light-528/download/mp3" preload="auto"></audio>

<script>
let peer, stream;
const pwdEl = document.getElementById("pwd");
const qrEl = document.getElementById("qr");
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const meVid = document.getElementById("me"), youVid = document.getElementById("you");
const readerDiv = document.getElementById("reader");
const notif = document.getElementById("notif");

function key() {
  const p = pwdEl.value;
  if (p.length < 8) throw "Password too short";
  return CryptoJS.SHA256(p).toString();
}
function enc(t){ return CryptoJS.AES.encrypt(t, key()).toString(); }
function dec(c){ try{return CryptoJS.AES.decrypt(c, key()).toString(CryptoJS.enc.Utf8);}catch(e){return "[Decrypt err]"}}
function log(txt){ chatEl.innerHTML += `<div>${txt}</div>`; chatEl.scrollTop = chatEl.scrollHeight; }
async function startOffer(){
  try{key();}catch(e){alert(e); return;}
  readerDiv.innerHTML = "";
  qrEl.innerHTML = "";
  stream = await navigator.mediaDevices.getUserMedia({video:1,audio:1});
  meVid.srcObject = stream;
  peer = new SimplePeer({initiator:true,trickle:false,stream});
  peer.on("signal", offer=>{
    const s = enc(JSON.stringify(offer));
    QRCode.toCanvas(s).then(canvas=>{
      qrEl.innerHTML = "";
      qrEl.appendChild(canvas);
    });
  });
  setupPeer();
}
function startScan(){
  qrEl.innerHTML = "";
  const scanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams=>{
    if(!cams.length) return alert("No camera found");
    scanner.start(cams[0].id,{fps:10,qrbox:250}, txt=>{
      scanner.stop();
      readerDiv.innerHTML="";
      const offer = JSON.parse(dec(txt));
      connectAnswer(offer);
    }, err=>{});
  }).catch(e=>alert("Scanner error"));
}
async function connectAnswer(offer){
  try{key();}catch(e){alert(e);return;}
  stream = await navigator.mediaDevices.getUserMedia({video:1,audio:1});
  meVid.srcObject = stream;
  peer = new SimplePeer({initiator:false,trickle:false,stream});
  peer.signal(offer);
  setupPeer();
}
function setupPeer(){
  peer.on("signal", ans=>{
    const s = enc(JSON.stringify(ans));
    QRCode.toCanvas(s).then(canvas=>{
      qrEl.innerHTML=""; qrEl.appendChild(canvas);
      log("üì∑ Scan this answer QR on the other phone to connect");
    });
  });
  peer.on("connect", ()=>{
    msgEl.disabled = sendBtn.disabled = false;
    log("‚úÖ Connected securely");
  });
  peer.on("data", data=>{
    const m = dec(data.toString());
    log("Peer: "+m);
    notif.play().catch();
  });
  peer.on("stream", s=>{ youVid.srcObject = s; });
  peer.on("error", err=>log("Error: "+ err.message));
}
function sendMsg(){
  const m = msgEl.value.trim();
  if(!m||!peer) return;
  peer.send(enc(m));
  log("You: "+m);
  msgEl.value="";
}
</script>
</body>
</html>
