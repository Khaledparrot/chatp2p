<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Secure QR-P2P Chat + Video</title>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 1em; }
    #chat { border: 1px solid #444; padding: 10px; min-height: 120px; max-height: 300px; overflow-y: auto; font-family: monospace; background: #1a1a1a; }
    video { width: 48%; margin: 5px 0; background: #000; }
    #qr-display, #reader { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>üîê Secure QR-P2P Chat + Video</h2>

  <label>Password (‚â•8 chars):</label>
  <input id="password" type="password" placeholder="Enter shared password" />

  <button id="startBtn" onclick="start()">üì° Start / Refresh Offer</button>

  <div id="qr-display"></div>
  <div id="reader" style="width:100%;"></div>

  <div id="chat">üîí Waiting for connection...</div>
  <input id="message" placeholder="Type a message..." disabled />
  <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
  <button onclick="clearChat()">üóë Clear Chat</button>

  <hr>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <audio id="notify" src="https://notificationsounds.com/notification-sounds/light-528/download/mp3" preload="auto"></audio>

  <script>
let peer, localStream, connected = false, chatHist = [], expiration = 30;
const pwd = document.getElementById('password');
const qrDisplay = document.getElementById('qr-display');
const chatEl = document.getElementById('chat');
const msgIn = document.getElementById('message'), sendBtn = document.getElementById('sendBtn');
const localV = document.getElementById('localVideo'), remoteV = document.getElementById('remoteVideo');
const reader = document.getElementById('reader'), notifier = document.getElementById('notify');
function key(){ const p=pwd.value; if(p.length<8) throw 'Pwd too short'; return CryptoJS.SHA256(p).toString(); }
function enc(t){ return CryptoJS.AES.encrypt(t,key()).toString(); }
function dec(c){ try{return CryptoJS.AES.decrypt(c,key()).toString(CryptoJS.enc.Utf8)||'[BadPwd]';}catch{ return '[Err]'; } }
function store(){ localStorage.setItem('qc', CryptoJS.AES.encrypt(JSON.stringify({c:chatHist,t:Date.now()}),key()).toString()); }
function load(){ try{ const d=CryptoJS.AES.decrypt(localStorage.qc,key()).toString(CryptoJS.enc.Utf8);
                    const o=JSON.parse(d); if((Date.now()-o.t)/60000<expiration){ chatHist=o.c; disp(); } else clearChat(); } catch{} }
function disp(){ chatEl.innerHTML = chatHist.map(m=>`<div><b>${m.f}</b>: ${m.t}</div>`).join(''); chatEl.scrollTop=chatEl.scrollHeight; }
function append(f,t){ chatHist.push({f,t}); disp(); store(); }
function clearChat(){ chatHist=[]; localStorage.removeItem('qc'); disp(); }
function start(){
  try{ key(); }catch(e){alert(e);return;}
  load(); navigator.mediaDevices.getUserMedia({video:1,audio:1}).then(s=>{
    localStream=s; localV.srcObject=s;
    peer=new SimplePeer({initiator:true,trickle:false,stream:s});
    peer.on('signal',o=>{
      const text=enc(JSON.stringify(o));
      qrDisplay.innerHTML = ''; new QRCode(qrDisplay, {text, width:240, height:240});
    });
    peer.on('connect',()=>{ connected=true; msgIn.disabled=sendBtn.disabled=false; append('üõ°Ô∏è System','Connected securely'); })
    .on('data',d=>{ const dc=dec(d.toString()); append('Peer',dc); notifier.play().catch(); })
    .on('stream',st=>{ remoteV.srcObject=st; })
    .on('error',e=>append('‚ö†Ô∏è Error',e.message));
    html5QrcodeScanner = new Html5QrcodeReader('reader', {fps:10,qrbox:250});
    html5QrcodeScanner.render(onScan,()=>{});
  }).catch(e=>alert('Media err'));
}
function onScan(txt){
  try{
    const dd=JSON.parse(dec(txt));
    peer.signal(dd); html5QrcodeScanner.clear().catch();
    qrDisplay.innerHTML='<b>Waiting‚Ä¶</b>';
  }catch{}
}
function sendMessage(){
  const m=msgIn.value.trim(); if(!m||!connected)return;
  peer.send(enc(m)); append('You',m); msgIn.value=''; }
</script>
</body>
</html>
