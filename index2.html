<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Secure QR P2P Chat (with fallback)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; padding:10px }
    input, button { width:100%; margin:5px 0; padding:10px; }
    #chat { background:#111; padding:10px; height:150px; overflow:auto; font-family:monospace }
    video { width:48%; margin:5px 0; background:#222 }
  </style>
</head>
<body>
  <h2>ğŸ” Secure QR P2P Chat</h2>
  <input id="pwd" type="password" placeholder="Shared password (â‰¥8 chars)">
  <button onclick="startOffer()">ğŸ“¤ Generate Offer QR</button>
  <div id="qr"></div>
  <button onclick="startScan()">ğŸ“· Scan Offer QR</button>
  <div id="reader" style="width:100%;height:300px"></div>

  <div id="chat">ğŸ’¬ Waiting for connection...</div>
  <input id="msg" disabled placeholder="Type message">
  <button id="sendBtn" disabled onclick="sendMsg()">Send</button>

  <video id="me" autoplay muted playsinline></video>
  <video id="you" autoplay playsinline></video>
  <audio id="notif" src="https://notificationsounds.com/notification-sounds/light-528/download/mp3" preload="auto"></audio>

<script>
let peer, stream;
const pwdEl = document.getElementById("pwd");
const qrEl = document.getElementById("qr");
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const meVid = document.getElementById("me"), youVid = document.getElementById("you");
const readerDiv = document.getElementById("reader");
const notif = document.getElementById("notif");

function key() {
  const p = pwdEl.value;
  if (p.length < 8) throw "Password too short";
  return CryptoJS.SHA256(p).toString();
}
function enc(t){ return CryptoJS.AES.encrypt(t, key()).toString(); }
function dec(c){ try{return CryptoJS.AES.decrypt(c, key()).toString(CryptoJS.enc.Utf8);}catch(e){return "[Decrypt error]"} }
function log(txt){ chatEl.innerHTML += `<div>${txt}</div>`; chatEl.scrollTop = chatEl.scrollHeight; }

async function getMedia() {
  try {
    return await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  } catch (e) {
    log("âš ï¸ No camera/mic found â€“ using chat only.");
    return null;
  }
}

async function startOffer() {
  try { key(); } catch (e) { alert(e); return; }
  readerDiv.innerHTML = "";
  qrEl.innerHTML = "";

  stream = await getMedia();
  if (stream) meVid.srcObject = stream;

  peer = new SimplePeer({ initiator: true, trickle: false, stream: stream || undefined });
  peer.on("signal", offer => {
    const s = enc(JSON.stringify(offer));
    QRCode.toCanvas(s).then(canvas => {
      qrEl.innerHTML = "";
      qrEl.appendChild(canvas);
    });
  });
  setupPeer();
}

function startScan() {
  qrEl.innerHTML = "";
  const scanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams => {
    if (!cams.length) return alert("No camera found");
    scanner.start(cams[0].id, { fps: 10, qrbox: 250 }, txt => {
      scanner.stop();
      readerDiv.innerHTML = "";
      const offer = JSON.parse(dec(txt));
      connectAnswer(offer);
    });
  }).catch(e => alert("QR Scan error: " + e));
}

async function connectAnswer(offer) {
  try { key(); } catch (e) { alert(e); return; }
  stream = await getMedia();
  if (stream) meVid.srcObject = stream;
  peer = new SimplePeer({ initiator: false, trickle: false, stream: stream || undefined });
  peer.signal(offer);
  setupPeer();
}

function setupPeer() {
  peer.on("signal", ans => {
    const s = enc(JSON.stringify(ans));
    QRCode.toCanvas(s).then(canvas => {
      qrEl.innerHTML = "";
      qrEl.appendChild(canvas);
      log("ğŸ“± Scan this QR on the other device");
    });
  });
  peer.on("connect", () => {
    msgEl.disabled = sendBtn.disabled = false;
    log("âœ… Connected securely");
  });
  peer.on("data", data => {
    const m = dec(data.toString());
    log("ğŸ‘¤ Peer: " + m);
    notif.play().catch(() => {});
  });
  peer.on("stream", s => { youVid.srcObject = s; });
  peer.on("error", err => log("âŒ Error: " + err.message));
}

function sendMsg() {
  const m = msgEl.value.trim();
  if (!m || !peer) return;
  peer.send(enc(m));
  log("ğŸ§ You: " + m);
  msgEl.value = "";
}
</script>
</body>
</html>
